#!/bin/bash
set -euo pipefail

# Collect SSH ports (fallback to 22)
mapfile -t ports < <(awk '
  $1 ~ /^(Port|LocalPort)$/ {print $2}
' /etc/ssh/sshd_config 2>/dev/null; \
  awk '$1 ~ /^(Port|LocalPort)$/ {print $2}' /etc/ssh/sshd_config.d/*.conf 2>/dev/null)
[[ ${#ports[@]} -eq 0 ]] && ports=(22)

host="$(hostname -f 2>/dev/null || hostname)"
addr="$(getent hosts "$host" | awk "NR==1{print \$1}")"
[[ -z "$addr" ]] && addr="$(hostname -I 2>/dev/null | awk '{print $1}')"

printf "%-6s %-24s %-6s\n" "PORT" "PermitUserEnvironment" "RESULT"
echo "-----------------------------------------------"

fail=0
for port in "${ports[@]}"; do
  cfg=$(/usr/sbin/sshd -T -C "user=root" -C "host=$host" -C "addr=$addr" -C "lport=$port" || true)
  val=$(awk 'BEGIN{IGNORECASE=1} /^permituserenvironment /{print $2}' <<<"$cfg")
  [[ -z "$val" ]] && val="(not set => no)"
  result="PASS"
  [[ "$val" != "yes" ]] && { result="FAIL"; fail=1; }
  printf "%-6s %-24s %-6s\n" "$port" "$val" "$result"
done

exit $fail
