data "aws_route53_zone" "this" {
  name         = var.zone_name
  private_zone = true
}

# TCP/22 health checks
resource "aws_route53_health_check" "primary" {
  type              = "TCP"
  fqdn              = var.primary_target
  port              = 22
  request_interval  = var.hc_interval
  failure_threshold = var.hc_fail_thresh
  tags = { Name = "sftp-primary-tcp22" }
}

resource "aws_route53_health_check" "secondary" {
  type              = "TCP"
  fqdn              = var.secondary_target
  port              = 22
  request_interval  = var.hc_interval
  failure_threshold = var.hc_fail_thresh
  tags = { Name = "sftp-secondary-tcp22" }
}

# Failover CNAME records (non-alias)
locals {
  fqdn = "${var.record_host}.${var.zone_name}" # e.g. "sftp.dev.nit-nis.awscfs.frb.pvt"
}

resource "aws_route53_record" "primary" {
  zone_id           = data.aws_route53_zone.this.zone_id
  name              = local.fqdn
  type              = "CNAME"
  ttl               = var.ttl
  records           = [var.primary_target]
  set_identifier    = "primary"
  health_check_id   = aws_route53_health_check.primary.id
  failover_routing_policy { type = "PRIMARY" }
}

resource "aws_route53_record" "secondary" {
  zone_id           = data.aws_route53_zone.this.zone_id
  name              = local.fqdn
  type              = "CNAME"
  ttl               = var.ttl
  records           = [var.secondary_target]
  set_identifier    = "secondary"
  health_check_id   = aws_route53_health_check.secondary.id
  failover_routing_policy { type = "SECONDARY" }
}


hcl
Copy code
# --------------------------- Input Variables ---------------------------

variable "region" {
  type        = string
  default     = "us-east-1"
  description = "AWS region where Route 53 and health checks will be created."
}

variable "zone_name" {
  type        = string
  description = "DNS hosted zone name (e.g., nit-nis.awscfs.frb.pvt). Must already exist."
}

variable "record_host" {
  type        = string
  description = "Prefix/hostname for the CNAME record (e.g., 'sftp.dev'). Will be combined with zone_name."
}

variable "primary_target" {
  type        = string
  description = "Primary SFTP endpoint hostname (e.g., sftp-west.dev.nit-nis.awscfs.frb.pvt)."
}

variable "secondary_target" {
  type        = string
  description = "Secondary SFTP endpoint hostname (e.g., sftp-east.dev.nit-nis.awscfs.frb.pvt)."
}

variable "ttl" {
  type        = number
  default     = 60
  description = "Time-to-live (TTL) in seconds for the DNS records."
}

variable "hc_interval" {
  type        = number
  default     = 30
  description = "Health check request interval in seconds. Must be 10 or 30."
}

variable "hc_fail_thresh" {
  type        = number
  default     = 3
  description = "Number of consecutive health check failures before marking endpoint as unhealthy."
}
