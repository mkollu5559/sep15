# modules/sftp_user/main.tf
resource "aws_transfer_user" "sftp_user" {
  server_id           = var.server_id
  user_name           = var.sftp_user_name
  home_directory_type = "LOGICAL"
  role                = var.sftp_role
  tags                = var.tags

  home_directory_mappings {
    entry  = "/"
    target = "/${var.sftp_home_dir}"
  }
}

# Use SSH public key stored in GitLab repo (instead of S3 object lookup)
resource "aws_transfer_ssh_key" "ssh_key" {
  server_id = var.server_id
  user_name = aws_transfer_user.sftp_user.user_name
  body      = file("${path.module}/files/${var.ssh_public_key_file}")

  lifecycle {
    create_before_destroy = true
  }
}
Variables (variables.tf)
hcl
Copy code
variable "server_id" {
  description = "The Transfer Family server ID."
  type        = string
}

variable "sftp_user_name" {
  description = "The SFTP username."
  type        = string
}

variable "sftp_home_dir" {
  description = "Home directory for the SFTP user."
  type        = string
}

variable "sftp_role" {
  description = "IAM role ARN for SFTP user access."
  type        = string
}

variable "tags" {
  description = "Tags to assign to the SFTP user."
  type        = map(string)
  default     = {}
}

variable "ssh_public_key_file" {
  description = "Path (relative to module) of the SSH public key file stored in GitLab."
  type        = string
}
Example usage (calling module)
hcl
Copy code
module "sftp_user_east" {
  source             = "./modules/sftp_user"
  server_id          = var.server_id
  sftp_user_name     = "east-user"
  sftp_home_dir      = "east/home"
  sftp_role          = var.sftp_role
  ssh_public_key_file = "id_rsa.pub"
  tags = {
    Environment = "east"
    Project     = "SFTP"
  }
}
